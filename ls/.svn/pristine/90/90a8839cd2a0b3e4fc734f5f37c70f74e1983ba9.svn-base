<?php
defined('BASEPATH') OR exit('No direct script access allowed');

class Order extends CI_Controller{

	public $islogin = 0;

	public function __construct(){
		parent::__construct();

        if(isset($_SESSION['user'])&&isset($_SESSION['style'])&&$_SESSION['style']===2)
		{
			$this->islogin=1;		
		}else{
			$this->islogin=0;
		}

	}
	public function index($page = 1)
	{

		//订单数量
		$numrows=$this->db->query("SELECT count(*) as numrows from shua_pay")->row()->numrows;
		//未完成
		$ondate=$this->db->query("select count(*) as wcount from shua_pay where status=2")->row()->wcount;

		$con='共有 <b>'.$numrows.'</b> 个订单，其中未完成的有 <b>'.$ondate.'</b> 个。';
		

   	
  		$page_size=10; //每页显示数量
        $start=($page-1)*$page_size;//每页从第几条开始
        $limit=" limit {$start},{$page_size}";//
    	$orders=$this->db->query("SELECT * FROM shua_pay WHERE 1 order by status asc, trade_no desc {$limit}")->result_array();


    	//获取分页标记
        $data['pager'] = $this->get_pager(array(
            'record_count'  => $numrows,
            'page_size'     => $page_size,
            'now_page'     => $page,
        ));


    	$data['con'] = $con;
		$data['title'] = '订单管理';
		$data['islogin'] = $this->islogin;
    	$data['c'] = 'order';
    	$data['orders'] = $orders;
    	$this->load->view('front/order@index',$data);
	}
/* 先不用
	public function query($page = 1)
	{
		$sql = " `qq`=".$_GET['kw'];//要搜索的qq

		$shuas=$this->db->query("SELECT * FROM shua_tools WHERE 1 order by sort asc")->result_array();
		$shua_func = array();
		$select = "";
		foreach ($shuas as $key => $shua) {
			$shua_func[$shua['tid']] = $shua['name'];
			$select.='<option value="'.$shua['tid'].'">'.$shua['name'].'</option>';
		}
		//订单总数
		$numrows=$this->db->query("SELECT count(*) as numrows from shua_orders WHERE{$sql}")->row()->numrows;
		//

		$con='包含 '.$_GET['kw'].' 的共有 <b>'.$numrows.'</b> 个订单';
		
		$page_size=10; //每页显示数量
        $start=($page-1)*$page_size;//每页从第几条开始
        $limit=" limit {$start},{$page_size}";//
    	$orders=$this->db->query("SELECT * FROM shua_orders WHERE{$sql}  {$limit}")->result_array();


    	//获取分页标记
        $data['pager'] = $this->get_pager(array(
            'record_count'  => $numrows,
            'page_size'     => $page_size,
            'now_page'     => $page,
        ));


		$data['shua_func'] = $shua_func;
		$data['select'] = $select;
    	$data['con'] = $con;
		$data['title'] = '订单管理';
		$data['islogin'] = $this->islogin;
    	$data['c'] = 'order';
    	// $data['pages'] = $pages;
    	$data['orders'] = $orders;
    	$this->load->view('admin/order',$data);
	}

*/
	public function detail($trade_no){
		$ordersql = "select * from shua_pay where trade_no='{$trade_no}' limit 1";
		$order = $this->db->query($ordersql)->row_array();
		$qqsql = "select * from trade_qq where trade_no='{$trade_no}'";
		$qqs = $this->db->query($qqsql)->result_array();


		$data['title'] = '订单详情';
		$data['islogin'] = $this->islogin;
    	$data['c'] = 'order';
    	$data['order'] = $order;
    	$data['qqs'] = $qqs;
    	$this->load->view('front/order@detail',$data);
	}
}
